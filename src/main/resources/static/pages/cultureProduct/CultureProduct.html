<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="initial-scale=1.0,user-scalable=no,maximum-scale=1,width=device-width">
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  <link href="../css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.bootcss.com/bootstrap-datepicker/1.8.0/css/bootstrap-datepicker.min.css" rel="stylesheet">
  <link href="https://cdn.bootcss.com/bootstrap-datepicker/1.8.0/css/bootstrap-datepicker.min.css" rel="stylesheet">
  <!-- Latest compiled and minified CSS -->
  <link rel="stylesheet" href="https://cdn.bootcss.com/bootstrap/3.3.7/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.12.1/bootstrap-table.min.css">
  <script src="../js/jquery.min.js"></script>
  <!-- Latest compiled and minified JavaScript -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.12.1/bootstrap-table.min.js"></script>

  <!-- Latest compiled and minified Locales -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.12.1/locale/bootstrap-table-zh-CN.min.js"></script>
  <!-- <script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=ZUONbpqGBsYGXNIYHicvbAbM"></script> -->
  <script src="https://cdn.bootcss.com/bootstrap/4.1.1/js/bootstrap.min.js"></script>
  <script src="https://cdn.bootcss.com/bootstrap-datepicker/1.8.0/js/bootstrap-datepicker.min.js"></script>

  <title>用户信息</title>

  <style>
    .nav{position:relative; width:100%;height: 10vh}
    .nav img{width:100%;}
    .nav middle{position:absolute;width:100%;left:0px;bottom:0px;top:10px;color: white;text-align: center;font-size: 18px}
    .nav left{position:absolute;width:200px;left:10px;bottom:0px;top:10px;color: white;text-align: left}

    tablelist{width:100vw}
    #tablelist tbody tr td{overflow-x: scroll}
    tablelist table-hover{width:100vw !important;}
    .fixed-table-body{height:75vh;}
    .search{
      width: 750px;
      line-height: 38px;
      display: flex;
    }
  </style>
</head>
<body>
<div class="nav">
  <img src="../../imgs/nav.jpg">
  <middle>演出订单管理</middle>
  <left onclick="backAction()">返回</left>
</div>
<div class="search">
  <div class="container-fluid">
    <div class="flex-row">
      <div class="col-xs-4">
        <div class="input-group">
          <span class="input-group-addon">订单编号</span>
          <input id="orderNumber" type="text" class="form-control" placeholder="输入订单编号" aria-describedby="basic-addon1">
        </div>
      </div>
      <div class="col-xs-4">
        <div class="input-group">
          <span class="input-group-addon">用户名</span>
          <input id="userName" type="text" class="form-control" placeholder="输入用户名" aria-describedby="basic-addon1">
        </div>
      </div>
      <div class="col-xs-2">
        <div class="input-group">
          <span class="input-group-addon">演出厅</span>
          <select id="performTheaterRoom" style="height: 33px;width: 100%" class="selectpicker">
            <option value="">全部</option>
            <option value="id1">演出厅1</option>
            <option value="id2">演出厅2</option>
            <option value="id3">演出厅3</option>
          </select>
        </div>
      </div>
      <!--    <div class="col-xs-2">-->
      <!--      <div class="input-group">-->
      <!--        <span class="input-group-addon">订单状态</span>-->
      <!--        <select id="orderstatus" style="height: 33px" class="selectpicker">-->
      <!--          <option value="">全部</option>-->
      <!--          <option value="2">广西省</option>-->
      <!--          <option value="3">福建省</option>-->
      <!--          <option value="4">湖南省</option>-->
      <!--          <option value="5">山东省</option>-->
      <!--        </select>-->
      <!--      </div>-->
      <!--    </div>-->
    </div><!-- /.row -->
    <div class="flex-row">
      <div class="col-xs-6">
        <div class="input-group">
          <span class="input-group-addon" id="perform-date">演出时间</span>
          <input id="performStartTime" type="date" class="form-control" placeholder="开始时间" aria-describedby="basic-addon1">
          <span class="input-group-addon">至</span>
          <input id="performEndTime" type="date" class="form-control" placeholder="结束时间" aria-describedby="basic-addon1">
        </div>
      </div>
      <div class="col-xs-5">
        <div class="input-group">
          <span class="input-group-addon" id="order-date">下单时间</span>
          <input id="orderStartTime" type="date" class="form-control" placeholder="开始时间" aria-describedby="basic-addon1">
          <span class="input-group-addon">至</span>
          <input id="orderEndTime" type="date" class="form-control" placeholder="结束时间" aria-describedby="basic-addon1">
        </div>
      </div>
    </div>
    <div>
      <div class="col-xs-2">
        <div class="input-group">
          <span class="input-group-addon">订单状态</span>
          <select id="orderStatus" style="height: 33px;width:100%" class="selectpicker">
            <option value="">全部</option>
            <option value="1">待提交</option>
            <option value="2">已提交/已预约</option>
            <option value="3">预约成功</option>
            <option value="4">已取消</option>
          </select>
        </div>
      </div>
      <div class="col-xs-2">
        <div class="input-group">
          <span class="input-group-addon">演出分类</span>
          <select id="performType" style="height: 33px;width:100%" class="selectpicker">
            <option value="">全部</option>
            <option value="1">演出分类1</option>
            <option value="2">演出分类2</option>
            <option value="3">演出分类3</option>
          </select>
        </div>
      </div>
      <div class="col-xs-2">
        <div class="input-group">
          <span class="input-group-addon">演出剧场</span>
          <select id="performTheater" style="height: 33px;width:100%" class="selectpicker">
            <option value="">全部</option>
            <option value="1">演出剧场1</option>
            <option value="2">演出剧场2</option>
            <option value="3">演出剧场3</option>
          </select>
        </div>
      </div>
      <div class="col-xs-4">
        <button class="btn btn-primary" style="height: 38px;background: teal;" onclick="searchDate()">查询</button>
        <button class="btn btn-primary" style="height: 38px;margin-left: 20px;background-color: #025aa5" onclick="resetData()">重置</button>
      </div>
    </div>
  </div>
  </div>
  <button class="btn btn-primary" style="height: 38px;background: teal;" onclick="getUserList()">查询</button>
  <button class="btn btn-primary" style="height: 38px;margin-left: 10px;" onclick="resetDate()">重置</button>
</div>

<div>
  <label style="margin-left: 10px;color: red" id="total"></label>
</div>
<table id="tablelist" style="top: 100px;width: 100vw;table-layout: fixed;"   data-height="70%"  data-mobile-responsive="true"></table>

<script type="text/javascript">
  var pageNumber=0,pageSize=500;
  var tableData;
  $(function () {

    $('#tablelist').bootstrapTable({
      columns: [
        {field: 'number', title: '序号'},
        {field: 'orderId', title: '订单编号'},
        {field: 'userName', title: '下单用户'},
        {field: 'performName', title: '演出名称'},
        {field: 'performStartTime', title: '演出开始时间'},
        {field: 'performEndTime', title: '演出结束时间'},
        {field: 'performType', title: '演出分类'},
        {field: 'performTheater', title: '演出剧场'},
        {field: 'performTheaterRoom', title: '演出厅'},
        {field: 'orderEndTime', title: '下单截止时间'},
        {field: 'status', title: '下单时间'},
        {field: 'status', title: '订单金额'},
        {field: 'status', title: '预约张数'},
        {field: 'status', title: '订单状态'},
        {field: 'operation', title: '操作'},
      ]
    });
  });

  function queryParams (params) {
    var keyWord = ($('#textfield').val());
    var startDate = timeStamp($('#start-date').val());
    var endDate = timeStamp($('#end-date').val());
    return {
      startTime : startDate,
      endTime : endDate,
      pageNumber:pageNumber,
      pageSize: pageSize,
      serviceId : getCookie("serviceId"),
      keyWord:keyWord
    };
  }

  function initLoading(){
    $("body").append("<!-- loading -->" +
      "<div class='modal fade' id='loading' tabindex='-1' role='dialog' aria-labelledby='myModalLabel' data-backdrop='static'>" +
      "<div class='modal-dialog' role='document'>" +
      "<div class='modal-content'>" +
      "<div class='modal-header'>" +
      "<h4 class='modal-title' id='myModalLabel'>提示</h4>" +
      "</div>" +
      "<div id='loadingText' class='modal-body'>" +
      "<span style='color: black' class='glyphicon glyphicon-refresh' aria-hidden='true'>1</span>" +
      "处理中，请稍候。。。" +
      "</div>" +
      "</div>" +
      "</div>" +
      "</div>"
    );
  }

  function getUserList(){
    var keyWord = ($('#textfield').val());
    var startDate = timeStamp($('#start-date').val());
    var endDate = timeStamp($('#end-date').val());
    showLoading("加载中...");
    setTimeout(function () {
      $.ajax({
        type: "GET",
        url: "/user/list",
        data: {
          startTime : startDate,
          endTime : endDate,
          pageNumber:pageNumber,
          pageSize:pageSize,
          serviceId : getCookie("serviceId"),
          keyWord:keyWord
        },
        success : function (data) {
          tableData=data.data;
          tableData.forEach(function (v,k) {
            tableData[k]['detail']="<div onclick='openDetails("+v.userId+")' >详情</div>"
          });
          hideLoading();
          configTable(tableData);
          getTotalData();
        },
        error: function () {
          hideLoading();
          $("#info").removeAttr("hidden");
          getTotalData();
        }
      });
    }, 500);
  }

  function getTotalData() {
    var keyWord = ($('#textfield').val());
    var startDate = timeStamp($('#start-date').val());
    var endDate = timeStamp($('#end-date').val());
    showLoading("加载中...");
    setTimeout(function () {
      $.ajax({
        type: "GET",
        url: "/user/list/statistics",
        data: {
          startTime : startDate,
          endTime : endDate,
          serviceId : getCookie("serviceId"),
          keyWord:keyWord
        },
        success : function (data) {
          console.log(data.data);
          var orderNumber = '当前搜索结果统计：订单数量:'+data.data.orderNumber;
          var orderAmount = '  订单总金额：￥'+data.data.orderAmount;
          var proxyAmount = '  代扣总金额：￥'+data.data.proxyAmount;
          var total = orderNumber+orderAmount+proxyAmount;
          console.log(orderNumber,orderAmount,proxyAmount);
          $('#total').text(''+total);
          hideLoading();
        },
        error: function () {
          hideLoading();
          $("#info").removeAttr("hidden");
        }
      });
    }, 500);
  }
  function configTable(tableData) {
    $('#tablelist').bootstrapTable('load', tableData);
  }

  function showLoading(text){
    $("#loadingText").html(text);
    $("#loading").modal("show");
  }
  function hideLoading(){
    $("#loading").modal("hide");
  }

  function getCookie(c_name)
  {
    if (document.cookie.length>0)
    {
      c_start=document.cookie.indexOf(c_name + "=")
      if (c_start!=-1)
      {
        c_start=c_start + c_name.length+1
        c_end=document.cookie.indexOf(";",c_start)
        if (c_end==-1) c_end=document.cookie.length
        return unescape(document.cookie.substring(c_start,c_end))
      }
    }
    return ""
  }

  function openDetails(id){
    window.location.href="UserInformationDetails.html?id="+id
  }

  function resetDate () {
    $('#start-date').val("");
    $('#end-date').val("");
  }

  // 转换日期至时间戳
  function timeStamp (val) {
    if (val) {
      return new Date(val).getTime();
    } else {
      return '';
    }
  }
</script>

<script>
  function backAction() {
    window.location.href = "UserStatistics.html"
  }
</script>
</body>
</html>